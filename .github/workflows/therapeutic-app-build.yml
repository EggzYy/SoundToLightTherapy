name: Therapeutic App Build

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Build Therapeutic App
      run: |
        echo "Building complete therapeutic app for iOS"

        IOS_SDK=$(xcrun --sdk iphoneos --show-sdk-path)
        echo "iOS SDK: $IOS_SDK"

        mkdir -p build

        xcrun -sdk iphoneos swiftc \
          -target arm64-apple-ios17.0 \
          -sdk "$IOS_SDK" \
          -O \
          -o build/TherapyApp \
          Sources/SoundToLightTherapyApp/main.swift \
          Sources/SoundToLightTherapy/Views/TherapyView.swift \
          Sources/SoundToLightTherapy/Views/DynamicTypeTestView.swift \
          Sources/SoundToLightTherapy/Managers/AudioCaptureManager.swift \
          Sources/SoundToLightTherapy/Managers/FlashlightController.swift \
          Sources/SoundToLightTherapy/Managers/FrequencyDetector.swift \
          Sources/SoundToLightTherapy/Managers/TherapySessionCoordinator.swift \
          Sources/SoundToLightTherapy/Utilities/DynamicTypeSupport.swift \
          Sources/SoundToLightTherapy/Utilities/HapticFeedbackSupport.swift \
          Sources/SoundToLightTherapy/Utilities/VoiceOverSupport.swift \
          Sources/SoundToLightTherapy/Utilities/ColorContrastSupport.swift \
          Sources/SoundToLightTherapy/Utilities/ReducedMotionSupport.swift \
          -framework Foundation \
          -framework UIKit \
          -framework SwiftUI \
          -framework AVFoundation \
          -framework Accelerate

        mkdir -p TherapyApp.app
        cp build/TherapyApp TherapyApp.app/

        cat > TherapyApp.app/Info.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleDisplayName</key>
    <string>Therapy App</string>
    <key>CFBundleExecutable</key>
    <string>TherapyApp</string>
    <key>CFBundleIdentifier</key>
    <string>com.eggzy.therapyapp</string>
    <key>CFBundleName</key>
    <string>TherapyApp</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0</string>
    <key>CFBundleVersion</key>
    <string>9</string>
    <key>LSRequiresIPhoneOS</key>
    <true/>
    <key>NSMicrophoneUsageDescription</key>
    <string>Used for therapeutic sound detection</string>
    <key>NSCameraUsageDescription</key>
    <string>Used for therapeutic flashlight control</string>
    <key>MinimumOSVersion</key>
    <string>17.0</string>
</dict>
</plist>
EOF

        mkdir -p Payload
        cp -r TherapyApp.app Payload/
        zip -r TherapyApp.ipa Payload/

        echo "Build complete"
        file build/TherapyApp
        ls -la *.ipa

    - uses: actions/upload-artifact@v4
      with:
        name: therapeutic-app
        path: TherapyApp.ipa
